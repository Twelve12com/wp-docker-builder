#!/bin/bash
source global.sh




# Install if not already
if [[ $IP == 127.0.0.1 ]] || [[ ! -f .env ]]; then

	echo "Redirecting to installation..."
	bash install
	exit

fi




# Get data from .env file
source .env




# Builder updates
self_update


echo "IMPORTING NEW DB STARTED"


echo "Closing server..."
docker-compose down
echo -e "Server is down ... ${GREEN}done${RESET}"


echo "Old data removing..."
rm -rf site/database/mysql/
echo -e "Remove old data ... ${GREEN}done${RESET}"


# Move the new files to be imported
if [[ -d site/import ]]; then


	# Move the SQL file
	count='ls -1 site/import/*.sql 2>/dev/null | wc -l'
	if [[ $count == 1 ]]; then 

		rm -rf site/database/dump/wordpress_data.sql
		mv site/import/*.sql site/database/dump/wordpress_data.sql

	fi


	# Move the wp-content folder
	if [[ -d site/import/wp-content ]]; then

		rm -rf site/wp/wp-content
		mv site/import/wp-content site/wp/wp-content

	fi


fi





echo "Site is building again..."
docker-compose up -d
echo -e "Build server again ... ${GREEN}done${RESET}"


# Check MySQL to be ready
wait_for_mysql


# Ask the registered URL and do the replacements
db_url_update


#Â Backup the DB after the changes
db_backup


echo -e "IMPORTING NEW DB ${GREEN}COMPLETE${RESET}"